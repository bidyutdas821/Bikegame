<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POV Forest Rider</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #87CEEB; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; }
        
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center; 
            background: rgba(0,0,0,0.7); z-index: 100;
        }
        .modal { 
            background: white; padding: 30px; border-radius: 20px; 
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        input { padding: 12px; width: 80%; margin: 15px 0; border: 2px solid #2d5a27; border-radius: 8px; }
        button { padding: 15px 30px; background: #2d5a27; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }

        /* HUD & Mobile Controls */
        #hud { position: absolute; top: 10px; left: 10px; color: white; font-weight: bold; pointer-events: none; display: none; }
        #controls { 
            position: absolute; bottom: 20px; width: 100%; display: none; 
            justify-content: space-between; padding: 0 20px; box-sizing: border-box; 
        }
        .btn { 
            width: 70px; height: 70px; background: rgba(255,255,255,0.3); 
            border: 2px solid white; border-radius: 50%; color: white; 
            display: flex; align-items: center; justify-content: center; 
            user-select: none; font-size: 1.5em;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="start-modal" class="modal">
            <h2>Enter player name:</h2>
            <input type="text" id="playerName" placeholder="Name" maxlength="10">
            <button id="startBtn">START ENGINE</button>
        </div>
        <div id="gameover-modal" class="modal hidden">
            <h2 style="color: #d9534f;">CRASHED!</h2>
            <p id="final-stats"></p>
            <button onclick="location.reload()">RETRY</button>
        </div>
    </div>

    <div id="hud">
        <div id="dist">0m</div>
    </div>

    <div id="controls">
        <div style="display:flex; gap:10px;">
            <div class="btn" id="btnLeft">L</div>
            <div class="btn" id="btnRight">R</div>
        </div>
        <div class="btn" id="btnGas" style="background:rgba(45, 90, 39, 0.5)">GO</div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let width, height, gameActive = false, playerName = "Rider";
let speed = 0, distance = 0, playerX = 0, track = [];
let trees = [], rocks = [];
let keys = {};

// --- Audio ---
const Audio = {
    ctx: null, osc: null, gain: null,
    init() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.osc = this.ctx.createOscillator();
        this.gain = this.ctx.createGain();
        this.osc.type = 'sawtooth';
        this.osc.connect(this.gain);
        this.gain.connect(this.ctx.destination);
        this.osc.start();
    },
    update(s) {
        if(!this.ctx) return;
        this.osc.frequency.setTargetAtTime(40 + s * 2, this.ctx.currentTime, 0.1);
        this.gain.gain.setTargetAtTime(gameActive ? 0.05 : 0, this.ctx.currentTime, 0.1);
    }
};

function initGame() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    
    // Create initial trees and rocks
    for(let i=0; i<40; i++) {
        trees.push({ z: i * 50, side: Math.random() > 0.5 ? 1 : -1 });
        if(i % 10 === 0 && i > 5) rocks.push({ z: i * 50, x: (Math.random() - 0.5) * 1.5 });
    }
    requestAnimationFrame(loop);
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

function update() {
    if(!gameActive) return;

    // Movement Logic
    if(keys['ArrowUp'] || keys['btnGas']) speed = Math.min(speed + 0.5, 60);
    else speed = Math.max(speed - 0.2, 0);

    if(keys['ArrowLeft'] || keys['btnLeft']) playerX -= 0.04 * (speed/30);
    if(keys['ArrowRight'] || keys['btnRight']) playerX += 0.04 * (speed/30);

    distance += speed * 0.1;
    document.getElementById('dist').innerText = Math.floor(distance) + "m";
    Audio.update(speed);

    // Obstacle Logic
    rocks.forEach(rock => {
        rock.z -= speed * 0.5;
        if(rock.z < 0) {
            rock.z = 1000;
            rock.x = (Math.random() - 0.5) * 1.5;
        }
        // Collision detection
        if(rock.z < 30 && rock.z > 0 && Math.abs(playerX - rock.x) < 0.3) {
            gameOver();
        }
    });

    trees.forEach(t => {
        t.z -= speed * 0.5;
        if(t.z < 0) t.z = 1000;
    });

    // Stay on screen
    playerX = Math.max(Math.min(playerX, 1.8), -1.8);
}

function draw() {
    ctx.clearRect(0,0,width,height);
    
    // Sky and Ground
    ctx.fillStyle = "#87CEEB"; ctx.fillRect(0,0,width,height/2);
    ctx.fillStyle = "#3e7a36"; ctx.fillRect(0,height/2,width,height/2);

    const horizon = height / 2;
    const roadW = width * 0.8;

    // Draw Road (Perspective)
    for(let i=0; i<100; i++) {
        let z = i * 10;
        let p1 = project(z, horizon);
        let p2 = project(z + 10, horizon);
        
        ctx.fillStyle = (Math.floor((i + distance*0.1) % 4) < 2) ? "#444" : "#333";
        ctx.beginPath();
        ctx.moveTo(p1.x - p1.w, p1.y);
        ctx.lineTo(p2.x - p2.w, p2.y);
        ctx.lineTo(p2.x + p2.w, p2.y);
        ctx.lineTo(p1.x + p1.w, p1.y);
        ctx.fill();

        // Lane markings
        if(i % 4 === 0) {
            ctx.fillStyle = "white";
            ctx.fillRect(p1.x - 2, p1.y, 4, p2.y - p1.y);
        }
    }

    // Draw Trees & Rocks
    [...trees, ...rocks].sort((a,b) => b.z - a.z).forEach(obj => {
        let p = project(obj.z, horizon, obj.x || (obj.side * 2));
        if(p.scale <= 0) return;
        
        if(obj.side) { // Tree
            ctx.fillStyle = "#1e3d1a";
            ctx.beginPath();
            ctx.moveTo(p.x, p.y); ctx.lineTo(p.x - 20*p.scale, p.y); ctx.lineTo(p.x, p.y - 80*p.scale); ctx.lineTo(p.x + 20*p.scale, p.y);
            ctx.fill();
        } else { // Rock
            ctx.fillStyle = "#777";
            ctx.beginPath();
            ctx.arc(p.x, p.y, 15 * p.scale, 0, Math.PI*2);
            ctx.fill();
        }
    });

    // Bike Dashboard / Handlebars (POV)
    ctx.fillStyle = "#222";
    ctx.fillRect(width/2 - 100, height - 50, 200, 50);
}

function project(z, horizon, xOffset = 0) {
    let scale = 100 / (z + 1);
    let x = (width/2) + (xOffset - playerX) * scale * 100;
    let y = horizon + (scale * 20);
    let w = scale * 100;
    return { x, y, w, scale };
}

function gameOver() {
    gameActive = false;
    document.getElementById('ui-layer').classList.remove('hidden');
    document.getElementById('start-modal').classList.add('hidden');
    document.getElementById('gameover-modal').classList.remove('hidden');
    document.getElementById('final-stats').innerText = `${playerName}, you covered ${Math.floor(distance)}m!`;
}

// Controls Logic
const setKey = (k, v) => keys[k] = v;
['btnLeft', 'btnRight', 'btnGas'].forEach(id => {
    const el = document.getElementById(id);
    el.onpointerdown = () => setKey(id, true);
    el.onpointerup = () => setKey(id, false);
});
window.onkeydown = e => setKey(e.code, true);
window.onkeyup = e => setKey(e.code, false);

document.getElementById('startBtn').onclick = () => {
    playerName = document.getElementById('playerName').value || "Rider";
    document.getElementById('ui-layer').classList.add('hidden');
    document.getElementById('hud').style.display = 'block';
    document.getElementById('controls').style.display = 'flex';
    Audio.init();
    gameActive = true;
};

initGame();
</script>
</body>
</html>
