<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mountain Forest Rider - Fixed</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #87CEEB; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center; 
            background: rgba(0,0,0,0.5); z-index: 10;
        }
        .modal { 
            background: white; padding: 30px; border-radius: 15px; 
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 320px;
        }
        input { padding: 12px; width: 80%; margin: 15px 0; border: 2px solid #2d5a27; border-radius: 8px; font-size: 16px; }
        button { 
            padding: 12px 30px; background: #2d5a27; color: white; 
            border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;
        }
        button:hover { background: #3e7a36; transform: scale(1.05); }
        #hud { 
            position: absolute; top: 20px; left: 20px; color: #1e3d1a; 
            font-weight: bold; text-shadow: 1px 1px 0px white; pointer-events: none;
            display: none; 
        }
        #high-score-tag { font-size: 0.7em; color: #666; margin-top: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="start-modal" class="modal">
            <h2 style="color: #2d5a27; margin-top: 0;">ðŸŒ² Forest Rider</h2>
            <p>Enter name to start:</p>
            <input type="text" id="playerName" placeholder="Your Name" maxlength="12">
            <div id="high-score-tag"></div>
            <br>
            <button id="startBtn">Start Race</button>
        </div>

        <div id="gameover-modal" class="modal hidden">
            <h2 style="color: #d9534f;">CRASHED!</h2>
            <p id="final-stats"></p>
            <button onclick="location.reload()">Restart Engine</button>
        </div>
    </div>

    <div id="hud">
        <div style="font-size: 0.8em; opacity: 0.8;" id="display-name">RIDER</div>
        <div id="distance-counter" style="font-size: 2.5em;">0m</div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- Audio Controller ---
const AudioController = {
    ctx: null, engineOsc: null, engineGain: null,
    init() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.engineOsc = this.ctx.createOscillator();
        this.engineGain = this.ctx.createGain();
        this.engineOsc.type = 'sawtooth';
        this.engineOsc.frequency.setValueAtTime(50, this.ctx.currentTime);
        this.engineGain.gain.setValueAtTime(0, this.ctx.currentTime);
        this.engineOsc.connect(this.engineGain);
        this.engineGain.connect(this.ctx.destination);
        this.engineOsc.start();
    },
    updateEngine(speed) {
        if (!this.ctx || this.ctx.state === 'suspended') return;
        const pitch = 40 + (Math.abs(speed) * 18);
        const volume = Math.min(0.02 + (Math.abs(speed) * 0.01), 0.1);
        this.engineOsc.frequency.setTargetAtTime(pitch, this.ctx.currentTime, 0.1);
        this.engineGain.gain.setTargetAtTime(volume, this.ctx.currentTime, 0.1);
    },
    playCrash() {
        if (!this.ctx) return;
        this.engineGain.gain.setTargetAtTime(0, this.ctx.currentTime, 0.05);
        const noise = this.ctx.createBufferSource();
        const buffer = this.ctx.createBuffer(1, this.ctx.sampleRate * 0.4, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
        noise.buffer = buffer;
        const g = this.ctx.createGain();
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.4);
        noise.connect(g); g.connect(this.ctx.destination);
        noise.start();
    }
};

// --- Game Constants & Variables ---
let width, height, score = 0, keys = {}, gameActive = false, playerName = "Rider";
let terrain = [], trees = [], mountains = [];
let bike = { x: 150, y: 0, vX: 0, vY: 0, rotation: 0, vRotation: 0, radius: 12, leanSpeed: 0.005, accel: 0.22 };

// --- Initialization ---
function init() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    
    // Display high score if it exists
    const savedScore = localStorage.getItem('forestRiderHiScore');
    if(savedScore) document.getElementById('high-score-tag').innerText = "Best: " + savedScore + "m";

    // Build world
    for (let i = 0; i < 30; i++) addTerrainSection(i * 100);
    for (let i = 0; i < 15; i++) mountains.push({ x: i * 600, h: 150 + Math.random() * 250, w: 500 + Math.random() * 500 });
    
    bike.y = getYAt(bike.x) - 50;
    requestAnimationFrame(gameLoop);
}

function addTerrainSection(x) {
    const lastY = terrain.length > 0 ? terrain[terrain.length - 1].y : height - 250;
    const newY = lastY + (Math.random() - 0.5) * 120;
    const clampedY = Math.max(height - 450, Math.min(height - 120, newY));
    terrain.push({ x: x, y: clampedY });
    if (Math.random() > 0.5) trees.push({ x: x, type: Math.floor(Math.random() * 2) });
}

function getYAt(x) {
    for (let i = 0; i < terrain.length - 1; i++) {
        if (x >= terrain[i].x && x <= terrain[i+1].x) {
            const t = (x - terrain[i].x) / (terrain[i+1].x - terrain[i].x);
            return terrain[i].y + t * (terrain[i+1].y - terrain[i].y);
        }
    }
    return height;
}

// --- Logic Update ---
function update() {
    if (!gameActive) return;

    if (keys['KeyW'] || keys['ArrowUp']) bike.vX += bike.accel;
    if (keys['KeyA'] || keys['ArrowLeft']) bike.vRotation -= bike.leanSpeed;
    if (keys['KeyD'] || keys['ArrowRight']) bike.vRotation += bike.leanSpeed;

    bike.vY += 0.25; // Gravity
    bike.vX *= 0.99; // Air Resistance
    bike.vRotation *= 0.95;
    bike.x += bike.vX;
    bike.y += bike.vY;
    bike.rotation += bike.vRotation;

    AudioController.updateEngine(bike.vX);

    const groundY = getYAt(bike.x);
    const normRot = ((bike.rotation + Math.PI) % (Math.PI * 2)) - Math.PI;

    // Crash Check
    if (Math.abs(normRot) > 2.1 && bike.y + bike.radius >= groundY - 3) {
        endGame();
    }

    // Ground Physics
    if (bike.y + bike.radius > groundY) {
        bike.y = groundY - bike.radius;
        bike.vY *= -0.15;
        const nextY = getYAt(bike.x + 5);
        const slope = Math.atan2(nextY - groundY, 5);
        bike.rotation += (slope - bike.rotation) * 0.2;
    }

    // Camera follow & procedural generation
    if (bike.x > width * 0.4) {
        const diff = bike.x - width * 0.4;
        bike.x = width * 0.4;
        score += diff * 0.1;
        document.getElementById('distance-counter').innerText = Math.floor(score) + "m";
        
        terrain.forEach(p => p.x -= diff);
        trees.forEach(t => t.x -= diff);
        mountains.forEach(m => m.x -= diff * 0.25);

        if (terrain[terrain.length-1].x < width + 200) addTerrainSection(terrain[terrain.length-1].x + 100);
    }
}

// --- Drawing ---
function draw() {
    ctx.clearRect(0, 0, width, height);

    // Mountains
    ctx.fillStyle = "#A3C4BC";
    mountains.forEach(m => {
        ctx.beginPath();
        ctx.moveTo(m.x, height);
        ctx.lineTo(m.x + m.w/2, height - m.h);
        ctx.lineTo(m.x + m.w, height);
        ctx.fill();
    });

    // Trees
    trees.forEach(t => {
        const ty = getYAt(t.x);
        ctx.fillStyle = "#1e3d1a";
        ctx.beginPath();
        ctx.moveTo(t.x, ty);
        ctx.lineTo(t.x - 15, ty);
        ctx.lineTo(t.x, ty - 45);
        ctx.lineTo(t.x + 15, ty);
        ctx.fill();
    });

    // Ground
    ctx.beginPath();
    ctx.moveTo(terrain[0].x, terrain[0].y);
    for (let i = 1; i < terrain.length; i++) ctx.lineTo(terrain[i].x, terrain[i].y);
    ctx.lineTo(width, height); ctx.lineTo(0, height);
    ctx.fillStyle = "#3e7a36"; ctx.fill();

    // Bike
    ctx.save();
    ctx.translate(bike.x, bike.y);
    ctx.rotate(bike.rotation);
    ctx.strokeStyle = "#222"; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(-12, 0); ctx.lineTo(0, -12); ctx.lineTo(12, 0); ctx.stroke();
    ctx.fillStyle = "#000";
    ctx.beginPath(); ctx.arc(-12, 0, 7, 0, Math.PI * 2); ctx.fill();
    ctx.beginPath(); ctx.arc(12, 0, 7, 0, Math.PI * 2); ctx.fill();
    ctx.restore();
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

// --- Control Flow ---
document.getElementById('startBtn').addEventListener('click', () => {
    const input = document.getElementById('playerName').value;
    if(input) playerName = input;
    
    document.getElementById('display-name').innerText = playerName.toUpperCase();
    document.getElementById('ui-layer').classList.add('hidden');
    document.getElementById('hud').style.display = 'block';
    
    AudioController.init();
    if (AudioController.ctx.state === 'suspended') AudioController.ctx.resume();
    
    gameActive = true;
});

function endGame() {
    gameActive = false;
    AudioController.playCrash();
    
    const finalDist = Math.floor(score);
    const hiScore = localStorage.getItem('forestRiderHiScore') || 0;
    if (finalDist > hiScore) localStorage.setItem('forestRiderHiScore', finalDist);

    document.getElementById('ui-layer').classList.remove('hidden');
    document.getElementById('start-modal').classList.add('hidden');
    document.getElementById('gameover-modal').classList.remove('hidden');
    document.getElementById('final-stats').innerText = `${playerName}, you rode ${finalDist}m!`;
}

window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);
window.addEventListener('resize', () => {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
});

init();
</script>
</body>
</html>
